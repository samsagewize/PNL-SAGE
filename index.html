<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trader - PnL Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { text-align: center; color: #2c3e50; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: center; border: 1px solid #ddd; }
    th { background: #3498db; color: white; }
    input { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 8px 16px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #27ae60; }
    .delete-btn { background: #e74c3c; }
    .delete-btn:hover { background: #c0392b; }
    .stats { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; }
    .stats h2 { margin-top: 0; color: #2c3e50; }
    select, input[type="date"] { padding: 8px; margin: 10px 0; }
    .highlight-win { background: #d5f4e0 !important; }
    .highlight-loss { background: #fce8e6 !important; }
  </style>
</head>
<body>
  <h1>Trader - Daily PnL Tracker</h1>

  <div style="text-align: center; margin: 20px;">
    <label>Filter by Date: </label>
    <input type="date" id="dateFilter">
    <button onclick="filterByDate()">Show Day</button>
    <button onclick="showAll()">Show All</button>
  </div>

  <table id="tradesTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Pair</th>
        <th>Long/Short</th>
        <th>Entry Price</th>
        <th>Exit Price</th>
        <th>Quantity</th>
        <th>Leverage</th>
        <th>Fees</th>
        <th>PnL ($)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tradesBody">
      <!-- Rows added dynamically -->
    </tbody>
    <tfoot>
      <tr>
        <td><input type="date" id="newDate"></td>
        <td><input type="text" id="newPair" placeholder="e.g. BTCUSDT"></td>
        <td>
          <select id="newDirection">
            <option>Long</option>
            <option>Short</option>
          </select>
        </td>
        <td><input type="number" step="0.01" id="newEntry"></td>
        <td><input type="number" step="0.01" id="newExit"></td>
        <td><input type="number" step="0.001" id="newQty"></td>
        <td><input type="number" id="newLeverage" value="10"></td>
        <td><input type="number" step="0.01" id="newFees" value="0"></td>
        <td colspan="2"><button onclick="addTrade()">Add Trade</button></td>
      </tr>
    </tfoot>
  </table>

  <div class="stats" id="stats">
    <h2>Daily Statistics</h2>
    <p><strong>Date:</strong> <span id="statDate">All Time</span></p>
    <p><strong>Total Trades:</strong> <span id="totalTrades">0</span></p>
    <p><strong>Winning Trades:</strong> <span id="wins">0</span> | <strong>Losing Trades:</strong> <span id="losses">0</span></p>
    <p><strong>Average Win:</strong> $<span id="avgWin">0.00</span> | <strong>Average Loss:</strong> $<span id="avgLoss">0.00</span></p>
    <p><strong>Win Rate:</strong> <span id="winRate">0%</span></p>
    <p><strong>Total PnL:</strong> $<span id="totalPnl">0.00</span></p>
    <p><strong>Profit Factor:</strong> <span id="profitFactor">0.00</span></p>
  </div>

  <script>
    const { DateTime } = luxon;
    let trades = JSON.parse(localStorage.getItem('traderTrades')) || [];

    function saveTrades() {
      localStorage.setItem('traderTrades', JSON.stringify(trades));
      renderTrades();
      updateStats();
    }

    function addTrade() {
      const date = document.getElementById('newDate').value || DateTime.now().toFormat('yyyy-MM-dd');
      const pair = document.getElementById('newPair').value || 'UNKNOWN';
      const direction = document.getElementById('newDirection').value;
      const entry = parseFloat(document.getElementById('newEntry').value) || 0;
      const exit = parseFloat(document.getElementById('newExit').value) || 0;
      const qty = parseFloat(document.getElementById('newQty').value) || 0;
      const leverage = parseFloat(document.getElementById('newLeverage').value) || 1;
      const fees = parseFloat(document.getElementById('newFees').value) || 0;

      if (!entry || !exit || !qty) {
        alert("Please fill Entry, Exit, and Quantity");
        return;
      }

      // PnL calculation for perps
      let pnl = direction === 'Long' 
        ? (exit - entry) * qty * leverage 
        : (entry - exit) * qty * leverage;
      pnl -= fees;

      trades.push({ date, pair, direction, entry, exit, qty, leverage, fees, pnl });
      saveTrades();

      // Clear inputs
      document.getElementById('newEntry').value = '';
      document.getElementById('newExit').value = '';
      document.getElementById('newQty').value = '';
      document.getElementById('newFees').value = '0';
      document.getElementById('newPair').value = '';
    }

    function deleteTrade(index) {
      trades.splice(index, 1);
      saveTrades();
    }

    function renderTrades(filterDate = null) {
      const tbody = document.getElementById('tradesBody');
      tbody.innerHTML = '';

      const filtered = filterDate 
        ? trades.filter(t => t.date === filterDate)
        : trades;

      filtered.sort((a, b) => b.date.localeCompare(a.date) || (b.pnl - a.pnl));

      filtered.forEach((trade, i) => {
        const globalIndex = trades.indexOf(trade);
        const row = document.createElement('tr');
        row.className = trade.pnl > 0 ? 'highlight-win' : trade.pnl < 0 ? 'highlight-loss' : '';
        
        row.innerHTML = `
          <td>${trade.date}</td>
          <td>${trade.pair}</td>
          <td>${trade.direction}</td>
          <td>${trade.entry.toFixed(2)}</td>
          <td>${trade.exit.toFixed(2)}</td>
          <td>${trade.qty}</td>
          <td>${trade.leverage}x</td>
          <td>${trade.fees.toFixed(2)}</td>
          <td>${trade.pnl.toFixed(2)}</td>
          <td><button class="delete-btn" onclick="deleteTrade(${globalIndex})">Delete</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateStats(filterDate = null) {
      const filtered = filterDate 
        ? trades.filter(t => t.date === filterDate)
        : trades;

      const wins = filtered.filter(t => t.pnl > 0);
      const losses = filtered.filter(t => t.pnl < 0);

      const totalWins = wins.reduce((sum, t) => sum + t.pnl, 0);
      const totalLosses = Math.abs(losses.reduce((sum, t) => sum + t.pnl, 0));

      const avgWin = wins.length ? (totalWins / wins.length) : 0;
      const avgLoss = losses.length ? (totalLosses / losses.length) : 0;
      const winRate = filtered.length ? (wins.length / filtered.length * 100) : 0;
      const totalPnl = filtered.reduce((sum, t) => sum + t.pnl, 0);
      const profitFactor = totalLosses === 0 ? 'âˆž' : (totalWins / totalLosses).toFixed(2);

      document.getElementById('statDate').textContent = filterDate || 'All Time';
      document.getElementById('totalTrades').textContent = filtered.length;
      document.getElementById('wins').textContent = wins.length;
      document.getElementById('losses').textContent = losses.length;
      document.getElementById('avgWin').textContent = avgWin.toFixed(2);
      document.getElementById('avgLoss').textContent = avgLoss.toFixed(2);
      document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
      document.getElementById('totalPnl').textContent = totalPnl.toFixed(2);
      document.getElementById('profitFactor').textContent = profitFactor;
    }

    function filterByDate() {
      const date = document.getElementById('dateFilter').value;
      if (date) {
        renderTrades(date);
        updateStats(date);
      }
    }

    function showAll() {
      document.getElementById('dateFilter').value = '';
      renderTrades();
      updateStats();
    }

    // Auto-set today's date in new trade row
    document.getElementById('newDate').value = DateTime.now().toFormat('yyyy-MM-dd');

    // Initial render
    renderTrades();
    updateStats();
  </script>
</body>
</html>
