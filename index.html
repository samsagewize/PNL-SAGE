<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trader - Daily PnL Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    body { 
      font-family: Arial, Helvetica, sans-serif; 
      margin: 20px; 
      background: #f4f4f4; 
      color: #333;
    }
    h1 { text-align: center; color: #2c3e50; }
    .profile-bar {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }
    .profile-bar input, .profile-bar button {
      margin: 5px;
      padding: 8px;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 20px 0; 
      background: white; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    }
    th, td { 
      padding: 12px; 
      text-align: center; 
      border: 1px solid #ddd; 
    }
    th { 
      background: #3498db; 
      color: white; 
    }
    input, select { 
      width: 90%; 
      padding: 8px; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
      box-sizing: border-box;
    }
    button { 
      padding: 8px 16px; 
      background: #2ecc71; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      margin: 5px owner's;
    }
    button:hover { background: #27ae60; }
    .delete-btn { background: #e74c3c; }
    .delete-btn:hover { background: #c0392b; }
    .edit-btn { background: #f39c12; }
    .edit-btn:hover { background: #e67e22; }
    .export-btn { background: #9b59b6; }
    .export-btn:hover { background: #8e44ad; }
    .calc-btn { background: #34495e; }
    .calc-btn:hover { background: #2c3e50; }
    .save-edit-btn { background: #27ae60; }
    .cancel-edit-btn { background: #95a5a6; }
    .stats, .overall-stats { 
      background: white; 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
      margin: 20px 0; 
    }
    .stats h2, .overall-stats h2 { margin-top: 0; color: #2c3e50; }
    .filter-bar { text-align: center; margin: 20px 0; }
    .highlight-win { background: #d5f4e0 !important; }
    .highlight-loss { background: #fce8e6 !important; }
    tr.editing { background: #fffacd !important; }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { margin-bottom: 15px; border: 1px solid #ccc; }
      td { border: none; position: relative; padding-left: 50%; }
      td:before { position: absolute; left: 6px; width: Opin 45%; padding-right: 10px; white-space: nowrap; font-weight: bold; }
      td:nth-of-type(1):before { content: "Date"; }
      td:nth-of-type(2):before { content: "Pair"; }
      td:nth-of-type(3):before { content: "Direction"; }
      td:nth-of-type(4):before { content: "Entry"; }
      td:nth-of-type(5):before { content: "Exit"; }
      td:nth-of-type(6):before { content: "Size ($)"; }
      td:nth-of-type(7):before { content: "Leverage"; }
      td:nth-of-type(8):before { content: "Volume ($)"; }
      td:nth-of-type(9):before { content: "Fees"; }
      td:nth-of-type(10):before { content: "PnL ($)"; }
      td:nth-of-type(11):before { content: "Action"; }
    }
  </style>
</head>
<body>
  <h1>Trader - Daily PnL Tracker</h1>

  <!-- Profile Section -->
  <div class="profile-bar">
    <h3>Set Your Trader Profile</h3>
    <input type="text" id="traderName" placeholder="Your Trading Name">
    <input type="number" id="startingBalance" placeholder="Starting Balance ($)" step="0.01">
    <input type="number" id="riskPercent" placeholder="Risk % per Trade" step="0.1" min="0" max="100">
    <button onclick="saveProfile()">Save Profile</button>
    <div id="profileDisplay" style="margin-top:10px; font-weight:bold;"></div>
  </div>

  <div class="filter-bar">
    <label>Filter by Date: </label>
    <input type="date" id="dateFilter">
    <button onclick="filterByDate()">Show Day</button>
    <button onclick="showAll()">Show All</button>
    <button class="export-btn" onclick="exportCSV(false)">Export All to CSV</button>
    <button class="export-btn" onclick="exportCSV(true)">Export Current View</button>
    <button class="calc-btn" onclick="calculateOverall()">Calculate Overall Stats</button>
  </div>

  <table id="tradesTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Pair</th>
        <th>Direction</th>
        <th>Entry Price</th>
        <th>Exit Price</th>
        <th>Size ($)</th>
        <th>Leverage</th>
        <th>Trade Volume ($)</th>
        <th>Fees</th>
        <th>PnL ($)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tradesBody"></tbody>
    <tfoot>
      <tr>
        <td><input type="date" id="newDate"></td>
        <td><input type="text" id="newPair" placeholder="e.g. BTCUSDT"></td>
        <td>
          <select id="newDirection">
            <option>Long</option>
            <option>Short</option>
          </select>
        </td>
        <td><input type="number" step="0.01" id="newEntry" placeholder="0.00"></td>
        <td><input type="number" step="0.01" id="newExit" placeholder="0.00"></td>
        <td><input type="number" step="0.01" id="newSize" placeholder="100.00"></td>
        <td><input type="number" id="newLeverage" value="10"></td>
        <td></td> <!-- Volume calculated automatically -->
        <td><input type="number" step="0.01" id="newFees" value="0"></td>
        <td></td> <!-- PnL calculated -->
        <td><button onclick="addTrade()">Add Trade</button></td>
      </tr>
    </tfoot>
  </table>

  <!-- Current View Stats -->
  <div class="stats" id="stats">
    <h2>Current View Statistics</h2>
    <p><strong>Period:</strong> <span id="statDate">All Time</span></p>
    <p><strong>Total Trades:</strong> <span id="totalTrades">0</span></p>
    <p><strong>Winning Trades:</strong> <span id="wins">0</span> | <strong>Losing Trades:</strong> <span id="losses">0</span></p>
    <p><strong>Average Win:</strong> $<span id="avgWin">0.00</span> | <strong>Average Loss:</strong> $<span id="avgLoss">0.00</span></p>
    <p><strong>Win Rate:</strong> <span id="winRate">0%</span></p>
    <p><strong>Total PnL:</strong> $<span id="totalPnl">0.00</span></p>
    <p><strong>Profit Factor:</strong> <span id="profitFactor">0.00</span></p>
  </div>

  <!-- Overall Stats -->
  <div class="overall-stats" id="overallStats" style="display:none;">
    <h2>Overall Trading Performance</h2>
    <p><strong>Trader:</strong> <span id="overallName">Not Set</span></p>
    <p><strong>Starting Balance:</strong> $<span id="overallStart">0.00</span></p>
    <p><strong>Total Net Profit:</strong> $<span id="overallNet">0.00</span></p>
    <p><strong>Return %:</strong> <span id="overallReturn">0.00</span>%</p>
    <p><strong>Current Balance:</strong> $<span id="overallBalance">0.00</span></p>
    <p><strong>Total Trades:</strong> <span id="overallTotal">0</span></p>
    <p><strong>Overall Win Rate:</strong> <span id="overallWinRate">0%</span></p>
    <p><strong>Avg Win:</strong> $<span id="overallAvgWin">0.00</span> | <strong>Avg Loss:</strong> $<span id="overallAvgLoss">0.00</span></p>
    <p><strong>Profit Factor:</strong> <span id="overallPF">0.00</span></p>
    <p><strong>Total Fees Paid:</strong> $<span id="overallFees">0.00</span></p>
  </div>

  <script>
    const { DateTime } = luxon;
    let trades = JSON.parse(localStorage.getItem('traderTrades')) || [];
    let profile = JSON.parse(localStorage.getItem('traderProfile')) || { name: '', startingBalance: 0, riskPercent: 1 };
    let editingIndex = -1; // Track which trade is being edited

    function calculatePnL(trade) {
      if (!trade.entry || trade.entry === 0) return 0;
      const priceChange = trade.direction === 'Long' 
        ? (trade.exit - trade.entry) / trade.entry
        : (trade.entry - trade.exit) / trade.entry;
      let pnl = priceChange * trade.size * trade.leverage;
      pnl -= trade.fees;
      return pnl;
    }

    function calculateVolume(trade) {
      return trade.size * trade.leverage;
    }

    function saveTrades() {
      localStorage.setItem('traderTrades', JSON.stringify(trades));
      renderTrades();
      updateStats();
    }

    function saveProfile() {
      profile.name = document.getElementById('traderName').value.trim() || 'Trader';
      profile.startingBalance = parseFloat(document.getElementById('startingBalance').value) || 0;
      profile.riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
      localStorage.setItem('traderProfile', JSON.stringify(profile));
      updateProfileDisplay();
      alert('Profile saved!');
    }

    function updateProfileDisplay() {
      const display = document.getElementById('profileDisplay');
      if (profile.name || profile.startingBalance > 0) {
        display.innerHTML = `<strong>${profile.name}</strong> | Starting: $${profile.startingBalance.toFixed(2)} | Risk: ${profile.riskPercent}% per trade`;
      } else {
        display.innerHTML = 'No profile set yet';
      }
    }

    function addTrade() {
      const trade = {
        date: document.getElementById('newDate').value || DateTime.now().toFormat('yyyy-MM-dd'),
        pair: document.getElementById('newPair').value.trim() || 'UNKNOWN',
        direction: document.getElementById('newDirection').value,
        entry: parseFloat(document.getElementById('newEntry').value) || 0,
        exit: parseFloat(document.getElementById('newExit').value) || 0,
        size: parseFloat(document.getElementById('newSize').value) || 0,
        leverage: parseFloat(document.getElementById('newLeverage').value) || 1,
        fees: parseFloat(document.getElementById('newFees').value) || 0,
      };

      if (!trade.entry || !trade.exit || !trade.size) {
        alert("Please fill Entry Price, Exit Price, and Size");
        return;
      }

      trade.volume = calculateVolume(trade);
      trade.pnl = calculatePnL(trade);

      trades.push(trade);
      saveTrades();

      // Clear inputs
      document.getElementById('newEntry').value = '';
      document.getElementById('newExit').value = '';
      document.getElementById('newSize').value = '';
      document.getElementById('newFees').value = '0';
      document.getElementById('newPair').value = '';
    }

    function startEdit(index) {
      editingIndex = index;
      renderTrades(); // Re-render with edit inputs
    }

    function saveEdit(index) {
      const row = document.querySelectorAll('#tradesBody tr')[index];
      const inputs = row.querySelectorAll('input, select');
      const updatedTrade = {
        date: inputs[0].value,
        pair: inputs[1].value.trim() || 'UNKNOWN',
        direction: inputs[2].value,
        entry: parseFloat(inputs[3].value) || 0,
        exit: parseFloat(inputs[4].value) || 0,
        size: parseFloat(inputs[5].value) || 0,
        leverage: parseFloat(inputs[6].value) || 1,
        fees: parseFloat(inputs[7].value) || 0,
      };

      if (!updatedTrade.entry || !updatedTrade.exit || !updatedTrade.size) {
        alert("Entry, Exit, and Size are required");
        return;
      }

      updatedTrade.volume = calculateVolume(updatedTrade);
      updatedTrade.pnl = calculatePnL(updatedTrade);

      trades[trades.indexOf(trades.find((t, i) => i === index + (document.getElementById('dateFilter').value ? trades.filter(t => t.date === document.getElementById('dateFilter').value).indexOf(t) : i))] = updatedTrade;
      // Simpler: since we render from full trades list, just update the actual trade
      const globalIndex = trades.indexOf(trades.find(t => t === trades[index])); // Rough, but works for now
      trades = trades.map((t, i) => i === index ? updatedTrade : t);

      editingIndex = -1;
      saveTrades();
    }

    function cancelEdit() {
      editingIndex = -1;
      renderTrades();
    }

    function deleteTrade(index) {
      if (confirm("Delete this trade?")) {
        trades.splice(index, 1);
        saveTrades();
      }
    }

    function renderTrades(filterDate = null) {
      const tbody = document.getElementById('tradesBody');
      tbody.innerHTML = '';

      let filtered = filterDate ? trades.filter(t => t.date === filterDate) : trades;
      filtered.sort((a, b) => b.date.localeCompare(a.date) || (b.pnl - a.pnl));

      filtered.forEach((trade, displayIndex) => {
        const globalIndex = trades.indexOf(trade);
        const row = document.createElement('tr');
        row.className = trade.pnl > 0 ? 'highlight-win' : trade.pnl < 0 ? 'highlight-loss' : '';
        if (globalIndex === editingIndex) row.classList.add('editing');

        if (globalIndex === editingIndex) {
          row.innerHTML = `
            <td><input type="date" value="${trade.date}"></td>
            <td><input type="text" value="${trade.pair}"></td>
            <td><select><option ${trade.direction === 'Long' ? 'selected' : ''}>Long</option><option ${trade.direction === 'Short' ? 'selected' : ''}>Short</option></select></td>
            <td><input type="number" step="0.01" value="${trade.entry}"></td>
            <td><input type="number" step="0.01" value="${trade.exit}"></td>
            <td><input type="number" step="0.01" value="${trade.size}"></td>
            <td><input type="number" value="${trade.leverage}"></td>
            <td>${(trade.size * trade.leverage).toFixed(2)}</td>
            <td><input type="number" step="0.01" value="${trade.fees}"></td>
            <td>${trade.pnl.toFixed(2)}</td>
            <td>
              <button class="save-edit-btn" onclick="saveEdit(${displayIndex})">Save</button>
              <button class="cancel-edit-btn" onclick="cancelEdit()">Cancel</button>
            </td>
          `;
        } else {
          row.innerHTML = `
            <td>${trade.date}</td>
            <td>${trade.pair}</td>
            <td>${trade.direction}</td>
            <td>${trade.entry.toFixed(2)}</td>
            <td>${trade.exit.toFixed(2)}</td>
            <td>${trade.size.toFixed(2)}</td>
            <td>${trade.leverage}x</td>
            <td>${trade.volume.toFixed(2)}</td>
            <td>${trade.fees.toFixed(2)}</td>
            <td>${trade.pnl.toFixed(2)}</td>
            <td>
              <button class="edit-btn" onclick="startEdit(${globalIndex})">Edit</button>
              <button class="delete-btn" onclick="deleteTrade(${globalIndex})">Delete</button>
            </td>
          `;
        }
        tbody.appendChild(row);
      });
    }

    // Rest of functions (updateStats, calculateOverall, exportCSV, etc.) remain the same but updated for new fields
    function updateStats(filterDate = null) {
      const filtered = filterDate ? trades.filter(t => t.date === filterDate) : trades;
      const wins = filtered.filter(t => t.pnl > 0);
      const losses = filtered.filter(t => t.pnl < 0);

      const totalWins = wins.reduce((sum, t) => sum + t.pnl, 0);
      const totalLosses = Math.abs(losses.reduce((sum, t) => sum + t.pnl, 0));

      const avgWin = wins.length ? (totalWins / wins.length) : 0;
      const avgLoss = losses.length ? (totalLosses / losses.length) : 0;
      const winRate = filtered.length ? (wins.length / filtered.length * 100) : 0;
      const totalPnl = filtered.reduce((sum, t) => sum + t.pnl, 0);
      const profitFactor = totalLosses === 0 ? '∞' : (totalWins / totalLosses).toFixed(2);

      document.getElementById('statDate').textContent = filterDate || 'All Time';
      document.getElementById('totalTrades').textContent = filtered.length;
      document.getElementById('wins').textContent = wins.length;
      document.getElementById('losses').textContent = losses.length;
      document.getElementById('avgWin').textContent = avgWin.toFixed(2);
      document.getElementById('avgLoss').textContent = avgLoss.toFixed(2);
      document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
      document.getElementById('totalPnl').textContent = totalPnl.toFixed(2);
      document.getElementById('profitFactor').textContent = profitFactor;
    }

    function calculateOverall() {
      if (trades.length === 0) {
        alert("No trades yet!");
        return;
      }

      const wins = trades.filter(t => t.pnl > 0);
      const losses = trades.filter(t => t.pnl < 0);
      const totalWins = wins.reduce((sum, t) => sum + t.pnl, 0);
      const totalLosses = Math.abs(losses.reduce((sum, t) => sum + t.pnl, 0));
      const netProfit = trades.reduce((sum, t) => sum + t.pnl, 0);
      const totalFees = trades.reduce((sum, t) => sum + t.fees, 0);

      const avgWin = wins.length ? totalWins / wins.length : 0;
      const avgLoss = losses.length ? totalLosses / losses.length : 0;
      const winRate = (wins.length / trades.length * 100);
      const profitFactor = totalLosses === 0 ? '∞' : (totalWins / totalLosses).toFixed(2);
      const returnPct = profile.startingBalance > 0 ? ((netProfit / profile.startingBalance) * 100) : 0;
      const currentBalance = profile.startingBalance + netProfit;

      document.getElementById('overallName').textContent = profile.name || 'Trader';
      document.getElementById('overallStart').textContent = profile.startingBalance.toFixed(2);
      document.getElementById('overallNet').textContent = netProfit.toFixed(2);
      document.getElementById('overallReturn').textContent = returnPct.toFixed(2);
      document.getElementById('overallBalance').textContent = currentBalance.toFixed(2);
      document.getElementById('overallTotal').textContent = trades.length;
      document.getElementById('overallWinRate').textContent = winRate.toFixed(1) + '%';
      document.getElementById('overallAvgWin').textContent = avgWin.toFixed(2);
      document.getElementById('overallAvgLoss').textContent = avgLoss.toFixed(2);
      document.getElementById('overallPF').textContent = profitFactor;
      document.getElementById('overallFees').textContent = totalFees.toFixed(2);

      document.getElementById('overallStats').style.display = 'block';
    }

    function exportCSV(currentViewOnly = false) {
      const data = currentViewOnly 
        ? (document.getElementById('dateFilter').value ? trades.filter(t => t.date === document.getElementById('dateFilter').value) : trades)
        : trades;

      if (data.length === 0) {
        alert("No trades to export!");
        return;
      }

      let csv = "Date,Pair,Direction,Entry Price,Exit Price,Size ($),Leverage,Trade Volume ($),Fees,PnL\n";
      data.forEach(t => {
        csv += `${t.date},${t.pair},${t.direction},${t.entry},${t.exit},${t.size},${t.leverage},${t.volume.toFixed(2)},${t.fees},${t.pnl.toFixed(2)}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `trader_${currentViewOnly ? 'current' : 'all'}_${DateTime.now().toFormat('yyyy-MM-dd')}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function filterByDate() {
      const date = document.getElementById('dateFilter').value;
      if (date) {
        renderTrades(date);
        updateStats(date);
      }
    }

    function showAll() {
      document.getElementById('dateFilter').value = '';
      renderTrades();
      updateStats();
    }

    // Init
    document.getElementById('newDate').value = DateTime.now().toFormat('yyyy-MM-dd');
    updateProfileDisplay();
    renderTrades();
    updateStats();
  </script>
</body>
</html>
