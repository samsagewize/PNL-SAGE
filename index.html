<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tradoor - Elevate Your Trading Journey</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    body { 
      font-family: Arial, Helvetica, sans-serif; 
      margin: 0;
      padding: 0 0 80px 0;
      background: #1a0033;
      color: #e6e6ff;
      min-height: 100vh;
    }
    h1 { text-align: center; color: #bb86fc; padding: 20px 0; margin: 0; }
    /* Top bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #2d1b4d;
    }
    .logo { font-size: 1.5em; font-weight: bold; }
    .profile-section {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    #profilePic {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 10px;
      border: 3px solid #bb86fc;
      object-fit: cover;
    }
    .profile-name { font-weight: bold; }
    /* Pages */
    .page { display: none; padding: 20px; }
    .page.active { display: block; }
    /* Profile Page */
    .profile-bar {
      background: #2d1b4d;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      max-width: 600px;
      margin: 20px auto;
      text-align: center;
    }
    .profile-bar input, .profile-bar button {
      margin: 10px;
      padding: 12px;
      width: 80%;
      border-radius: 8px;
      border: none;
    }
    .profile-bar button { background: #bb86fc; color: #1a0033; font-weight: bold; cursor: pointer; }
    #profileDisplay { margin-top: 20px; font-size: 1.2em; }
    #profileImageUpload { display: none; }
    .upload-label {
      display: block;
      background: #bb86fc;
      color: #1a0033;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px auto;
      width: 80%;
    }
    /* Dashboard welcome */
    .welcome-dashboard {
      text-align: center;
      margin: 20px 0;
    }
    .welcome-dashboard img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid #bb86fc;
      object-fit: cover;
    }
    /* Table and stats */
    table { width: 100%; border-collapse: collapse; margin: 20px 0; background: #2d1b4d; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    th, td { padding: 12px; text-align: center; border: 1px solid #4a2a7d; }
    th { background: #bb86fc; color: #1a0033; }
    input, select { width: 90%; padding: 8px; background: #4a2a7d; color: #e6e6ff; border: 1px solid #bb86fc; border-radius: 4px; box-sizing: border-box; }
    button { padding: 8px 16px; background: #bb86fc; color: #1a0033; border: none; border-radius: 4px; cursor: pointer; margin: 5px; font-weight: bold; }
    button:hover { background: #cf9fff; }
    .delete-btn { background: #e74c3c; color: white; }
    .edit-btn { background: #f39c12; color: white; }
    .export-btn { background: #9b59b6; color: white; }
    .calc-btn { background: #34495e; color: white; }
    .save-edit-btn { background: #27ae60; color: white; }
    .cancel-edit-btn { background: #95a5a6; color: white; }
    .upgrade-btn { background: #ffd700; color: #1a0033; font-weight: bold; }
    .pro-feature { display: none; }
    .pro-feature.active { display: block; }
    .stats, .overall-stats { background: #2d1b4d; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); margin: 20px 0; }
    .stats h2, .overall-stats h2 { margin-top: 0; color: #bb86fc; }
    .filter-bar { text-align: center; margin: 20px 0; }
    .highlight-win { background: #0d402d !important; }
    .highlight-loss { background: #590000 !important; }
    tr.editing { background: #4a0072 !important; }
    /* Bottom Menu */
    .bottom-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #2d1b4d;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
      z-index: 100;
    }
    .menu-btn {
      background: none;
      border: none;
      color: #bb86fc;
      font-size: 1.5em;
      cursor: pointer;
      padding: 10px;
    }
    .menu-btn.active { color: #ffffff; border-top: 3px solid #bb86fc; padding-top: 7px; }
    @media (max-width: 768px) { .menu-btn { font-size: 1.8em; } }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="logo">Tradoor</div>
    <div class="profile-section" onclick="showPage('profile')">
      <img id="profilePic" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Trader" alt="Profile">
      <div class="profile-name" id="topProfileName">Trader</div>
    </div>
  </div>

  <h1 id="pageTitle">Tradoor</h1>

  <!-- Profile Page -->
  <div id="profile" class="page">
    <div class="profile-bar">
      <h3>Create Your Tradoor Profile</h3>
      <img id="largeProfilePic" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Trader" alt="Profile" style="width:150px;height:150px;border-radius:50%;border:4px solid #bb86fc;object-fit:cover;">
      <label class="upload-label" for="profileImageUpload">Change Profile Picture</label>
      <input type="file" id="profileImageUpload" accept="image/*">
      <input type="text" id="traderName" placeholder="Your Trading Name">
      <input type="number" id="startingBalance" placeholder="Starting Balance ($)" step="0.01">
      <input type="number" id="riskPercent" placeholder="Risk % per Trade" step="0.1" min="0" max="100">
      <button onclick="saveProfile()">Save & Go to Dashboard</button>
      <div id="profileDisplay"></div>
    </div>
  </div>

  <!-- Dashboard / Trades Page -->
  <div id="trades" class="page active">
    <div class="welcome-dashboard">
      <img id="dashboardProfilePic" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Trader" alt="Profile" >
      <h2>Welcome back, <span id="welcomeName">Trader</span>!</h2>
      <p>Let's track and improve your trading journey today.</p>
    </div>

    <div class="filter-bar">
      <label>Filter by Date: </label>
      <input type="date" id="dateFilter">
      <button onclick="filterByDate()">Show Day</button>
      <button onclick="showAll()">Show All</button>
      <button class="export-btn" onclick="exportCSV(false)">Export All</button>
      <button class="export-btn" onclick="exportCSV(true)">Export View</button>
      <button class="calc-btn" onclick="calculateOverall()">Overall Stats</button>
    </div>

    <table id="tradesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Pair</th>
          <th>Dir</th>
          <th>Entry</th>
          <th>Exit</th>
          <th>Size ($)</th>
          <th>Leverage</th>
          <th>Volume ($)</th>
          <th>Fees</th>
          <th>PnL ($)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tradesBody"></tbody>
      <tfoot>
        <tr>
          <td><input type="date" id="newDate"></td>
          <td><input type="text" id="newPair" placeholder="BTCUSDT"></td>
          <td><select id="newDirection"><option>Long</option><option>Short</option></select></td>
          <td><input type="number" step="0.01" id="newEntry"></td>
          <td><input type="number" step="0.01" id="newExit"></td>
          <td><input type="number" step="0.01" id="newSize" placeholder="100"></td>
          <td><input type="number" id="newLeverage" value="10"></td>
          <td></td>
          <td><input type="number" step="0.01" id="newFees" value="0"></td>
          <td></td>
          <td><button onclick="addTrade()">Add</button></td>
        </tr>
      </tfoot>
    </table>

    <div class="stats" id="stats">
      <h2>Current View Stats</h2>
      <p><strong>Period:</strong> <span id="statDate">All Time</span></p>
      <p><strong>Trades:</strong> <span id="totalTrades">0</span></p>
      <p><strong>Wins:</strong> <span id="wins">0</span> | <strong>Losses:</strong> <span id="losses">0</span></p>
      <p><strong>Avg Win:</strong> $<span id="avgWin">0.00</span> | <strong>Avg Loss:</strong> $<span id="avgLoss">0.00</span></p>
      <p><strong>Win Rate:</strong> <span id="winRate">0%</span></p>
      <p><strong>Total PnL:</strong> $<span id="totalPnl">0.00</span></p>
      <p><strong>Profit Factor:</strong> <span id="profitFactor">0.00</span></p>
    </div>

    <div class="overall-stats" id="overallStats" style="display:none;">
      <h2>Overall Performance</h2>
      <p><strong>Trader:</strong> <span id="overallName">Not Set</span></p>
      <p><strong>Starting:</strong> $<span id="overallStart">0.00</span></p>
      <p><strong>Net Profit:</strong> $<span id="overallNet">0.00</span></p>
      <p><strong>Return:</strong> <span id="overallReturn">0.00</span>%</p>
      <p><strong>Balance:</strong> $<span id="overallBalance">0.00</span></p>
      <p><strong>Trades:</strong> <span id="overallTotal">0</span></p>
      <p><strong>Win Rate:</strong> <span id="overallWinRate">0%</span></p>
      <p><strong>Avg Win:</strong> $<span id="overallAvgWin">0.00</span> | <strong>Avg Loss:</strong> $<span id="overallAvgLoss">0.00</span></p>
      <p><strong>Profit Factor:</strong> <span id="overallPF">0.00</span></p>
      <p><strong>Fees Paid:</strong> $<span id="overallFees">0.00</span></p>
      <!-- Pro features remain the same -->
      <div id="proAnalytics" class="pro-feature">
        <h3>Pro Analytics (Powered by Grok)</h3>
        <!-- ... same as before ... -->
      </div>
      <div id="proUpgrade" style="text-align:center; margin:20px;">
        <button class="upgrade-btn" onclick="upgradeToPro()">Upgrade to Pro for $5</button>
        <p>Unlock Grok-powered insights and advanced analytics!</p>
      </div>
    </div>
  </div>

  <!-- Bottom Menu -->
  <div class="bottom-menu">
    <button class="menu-btn active" onclick="showPage('trades')">ðŸ“Š Dashboard</button>
    <button class="menu-btn" onclick="showPage('profile')">ðŸ‘¤ Profile</button>
  </div>

  <script>
    const { DateTime } = luxon;
    let trades = JSON.parse(localStorage.getItem('tradoorTrades')) || [];
    let profile = JSON.parse(localStorage.getItem('tradoorProfile')) || { 
      name: 'Trader', 
      startingBalance: 0, 
      riskPercent: 1, 
      isPro: false,
      profilePic: null  // Base64 or URL
    };
    let editingIndex = -1;

    // Generate default NPC avatar based on name
    function generateAvatar(seed) {
      return `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(seed || 'Trader')}`;
    }

    function updateAllProfilePics() {
      const src = profile.profilePic || generateAvatar(profile.name);
      document.getElementById('profilePic').src = src;
      document.getElementById('largeProfilePic').src = src;
      document.getElementById('dashboardProfilePic').src = src;
      document.getElementById('topProfileName').textContent = profile.name || 'Trader';
      document.getElementById('welcomeName').textContent = profile.name || 'Trader';
    }

    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`[onclick="showPage('${pageId}')"]`).classList.add('active');
      document.getElementById('pageTitle').textContent = pageId === 'trades' ? 'Tradoor Dashboard' : 'Profile';

      if (pageId === 'trades') {
        renderTrades();
        updateStats();
      } else if (pageId === 'profile') {
        updateProfileDisplay();
      }
    }

    function saveProfile() {
      const nameInput = document.getElementById('traderName').value.trim();
      profile.name = nameInput || 'Trader';
      profile.startingBalance = parseFloat(document.getElementById('startingBalance').value) || 0;
      profile.riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
      
      localStorage.setItem('tradoorProfile', JSON.stringify(profile));
      updateAllProfilePics();
      updateProfileDisplay();
      alert('Profile saved! Welcome to your dashboard.');
      showPage('trades'); // Go to dashboard after save
    }

    function updateProfileDisplay() {
      const display = document.getElementById('profileDisplay');
      if (profile.name || profile.startingBalance > 0) {
        display.innerHTML = `<strong>${profile.name}</strong><br>Starting: $${profile.startingBalance.toFixed(2)}<br>Risk: ${profile.riskPercent}% per trade`;
      } else {
        display.innerHTML = 'Complete your profile to unlock your dashboard!';
      }
      // Pre-fill inputs
      document.getElementById('traderName').value = profile.name === 'Trader' ? '' : profile.name;
      document.getElementById('startingBalance').value = profile.startingBalance || '';
      document.getElementById('riskPercent').value = profile.riskPercent || '';
    }

    // Profile picture upload
    document.getElementById('profileImageUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          profile.profilePic = ev.target.result;
          updateAllProfilePics();
        };
        reader.readAsDataURL(file);
      }
    });

    // Rest of the functions (calculatePnL, addTrade, renderTrades, etc.) remain the same as previous version
    // ... (include all previous trade functions here - addTrade, renderTrades, updateStats, calculateOverall, exportCSV, etc.)

    // For brevity, assuming the rest is unchanged from the last version
    // Just add the init call for profile pics
    updateAllProfilePics();

    // Init
    document.getElementById('newDate').value = DateTime.now().toFormat('yyyy-MM-dd');
    updateProfileDisplay();
    renderTrades();
    updateStats();

    // If user has no name set, encourage profile creation
    if (!profile.name || profile.name === 'Trader' && !profile.startingBalance) {
      showPage('profile');
    }
  </script>
</body>
</html>
